<!DOCTYPE html>
<html lang="en-us">

<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
  <meta name="description" content="初心者・中級者向けC++/Pythonプログラミング"/>
  <meta name="robots" content="index,follow"/>

  <title>
    
      マーチング・キューブ法 &middot; programming-for-beginners
    
  </title>

  
  <link rel="canonical" href="https://tatsy.github.io/programming-for-beginners/cpp/march-cubes/">
  

  <link rel="stylesheet" href="https://tatsy.github.io/programming-for-beginners/public/css/poole.css">
  <link rel="stylesheet" href="https://tatsy.github.io/programming-for-beginners/public/css/syntax.css">
  <link rel="stylesheet" href="https://tatsy.github.io/programming-for-beginners/public/css/lanyon.css">
  <link rel="stylesheet" href="https://tatsy.github.io/programming-for-beginners/public/css/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://tatsy.github.io/programming-for-beginners/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="https://tatsy.github.io/programming-for-beginners/public/favicon.ico">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://tatsy.github.io/programming-for-beginners/atom.xml">

  <script type="text/javascript" src="/programming-for-beginners/public/js/jquery.min.js"></script>
  <script type="text/javascript" src="/programming-for-beginners/public/js/lightbox.min.js"></script><script>
MathJax = {
    tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        tags: "ams",
        autoload: {
            color: [],
            colorV2: ['color']
        },
        packages: {'[+]': ['noerrors']}
    },
    chtml: {
        scale: 1.1,
        matchFontHeight: false,
        displayAlign: "left",
        displayIndent: "2em"
    },
    options: {
        renderActions: {
            /* add a new named action to render <script type="math/tex"> */
            find_script_mathtex: [10, function (doc) {
            for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = {node: text, delim: '', n: 0};
                math.end = {node: text, delim: '', n: 0};
                doc.math.push(math);
            }
            }, '']
        }
    },
    loader: {
        load: ['[tex]/noerrors']
    }
};
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>
</head>


<body>

  <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
    styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>初心者・中級者向けC++/Pythonプログラミング</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="https://tatsy.github.io/programming-for-beginners/">Home</a>

    

    
    
      
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="https://tatsy.github.io/programming-for-beginners/cpp/">C++プログラミング</a>
        
      
    
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="https://tatsy.github.io/programming-for-beginners/python/">Pythonプログラミング</a>
        
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://github.com/tatsy/programming-for-beginners">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.0.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2020. All rights reserved.
    </p>
  </div>
</div>


  <!-- Wrap is the content to shift when toggling the sidebar. We wrap the content to avoid any CSS collisions with our real content. -->
  <div class="wrap">
    <div class="masthead">
      <div class="container">
        <h3 class="masthead-title">
          <a href="/programming-for-beginners/" title="Home">programming-for-beginners</a>
          <small>Programming for everyone!</small>
        </h3>
      </div>
    </div>

    <div class="container content">
      <div class="post">
  <h1 class="post-title">マーチング・キューブ法</h1>
  <p><a href="https://dl.acm.org/doi/10.1145/37402.37422" target="_blank">マーチング・キューブ法</a>は1987年にLorensenとClineによって提案されたアルゴリズムで、2020年現在、コンピュータ・グラフィクスのトップ・ジャーナルであるACM Transactions of Graphicsにおいて、最も引用されている論文です。</p>

<p>今日、マーチング・キューブ法とその発展形はCTやMRIなどで得られる三次元ボリュームデータを表面メッシュデータに置き換える方法として広く利用されています。</p>

<p>マーチング・キューブ法のアイディアは単純で、1つのキューブが持つ8つの頂点が表面メッシュの内側にあるのか、外側になるのかのすべてのパターンについて、どのようにメッシュが切られるべきなのかを表す辞書を用意します。</p>

<p>これらのパターンは単純には2の8乗、すなわち256通りのパターンが考えられるが、回転や鏡面対称のものをまとめると、以下の図に示すような15種類のデータとなる。</p>

<p><a class="lightbox-link" href="/programming-for-beginners/public/images/march_cubes/march_cubes.jpg" data-lightbox="images-1" data-title=""><img src="/programming-for-beginners/public/images/march_cubes/march_cubes.jpg" alt="" style="" /></a>
 <br />
(<a href="https://ja.wikipedia.org/wiki/%E3%83%9E%E3%83%BC%E3%83%81%E3%83%B3%E3%82%B0%E3%82%AD%E3%83%A5%E3%83%BC%E3%83%96%E6%B3%95" target="_blnak">『マーチングキューブ法 - Wikipedia』</a>より引用)</p>

<p>これらの辞書の用意と、回転や考慮したメッシュへの変換は煩雑ではあるが、幸運なことに、ウェブ上に基本的な実装を含むソースコードが多数公開されている。</p>

<p>今回は<a href="http://paulbourke.net/geometry/polygonise/" target="_blank">http://paulbourke.net/geometry/polygonise/</a>で公開されているコードを元に、マーチング・キューブ法を実装していく。</p>

<h2 id="処理の流れ">処理の流れ</h2>

<p>上記のウェブページに公開されているコードでは<code class="highlighter-rouge">GRIDCELL</code>が冒頭の図で言うところのキューブひとつに対応する。この構造体に対して、8つのコーナーの位置と、そのコーナーが持つ<em>ボリュームの値を<code class="highlighter-rouge">double</code>で格納する</em>。</p>

<p>その結果を<code class="highlighter-rouge">Polygonize</code>関数に閾値 (こちらも<code class="highlighter-rouge">double</code>型)で渡す。すると、第3引数にある三角形 (<code class="highlighter-rouge">TRIANGLE</code>型) の配列に対して、三角形とその頂点位置を代入してくれる。何個の三角形を生成したかは<code class="highlighter-rouge">Polygonize</code> 関数の戻り値に格納される。</p>

<p>あとは<code class="highlighter-rouge">TRIANGLE</code>型の配列は三角形の個数分処理して、出力の頂点リストと面を構成する頂点番号リスト(テンプレートコードではそれぞれ<code class="highlighter-rouge">vertices</code>と<code class="highlighter-rouge">indices</code>)に格納すれば良い。これらの手順を元にテンプレートのプログラムを埋めて、マーチング・キューブのプログラムを完成させよう。</p>

<h2 id="補足-マーチングキューブ法の拡張">補足: マーチング・キューブ法の拡張</h2>

<p>マーチング・キューブ法にはいくつかの問題点が知られており、それらを解決する方法も多く提案されている。なお、CTなどのボリューム・データを扱う場合は、そもそも情報が十分に細かく、各ボクセルでマーチング・キューブを実行できるので、以下の議論を利用する場面はそれほど多くはない。</p>

<p><strong>1つ目の問題</strong>は、特にキューブの取り方がメッシュの細かさに対して荒い場合に起こる問題で、隣あうキューブの間で三角形面が連続せずに穴が空いてしまう。この問題については以下の論文の図3を見てほしい。</p>

<p>Nielsen and Hamann 1991, “The Asymptotic Decider: Resolving the Ambiguity in Marching Cubes” <br />
<a href="http://web.cse.ohio-state.edu/~shen.94/788/Site/Reading_files/p83-nielson.pdf" target="_blank">http://web.cse.ohio-state.edu/~shen.94/788/Site/Reading_files/p83-nielson.pdf</a></p>

<p>上記の論文では、このような曖昧さを解決するために、曖昧となりうるパターンには複数の候補を考えておき、適宜隣のキューブが発生させた三角形ときちんと繋がるような三角形を発生させるという方法を取っている。</p>

<p>また、これとは違う考え方で、曖昧さの問題を解決した手法に<strong>Marching Tetrahedra</strong>がある。この方法は、立方体を6つの四面体に分割して、各四面体に対して面貼りのパターンを割り当てるというものである。</p>

<p>Treece et al. 1998, “Regularized marching tetrahedra: improved iso-surface extraction” <br />
<a href="http://svr-www.eng.cam.ac.uk/reports/svr-ftp/treece_tr333.pdf" target="_blank">http://svr-www.eng.cam.ac.uk/reports/svr-ftp/treece_tr333.pdf</a></p>

<p>四面体は頂点がそもそも4つしかないため、対称性などを考慮しなくても、パターンはたったの16種類しかなく、実装の苦労が少ないのがもう一つの特徴である。</p>

<p><strong>2つ目の問題</strong>は、マーチング・キューブ法で細かなメッシュを再構成しようとしたときには、キューブを細かく切る以外にあまり良い方法がなく、荒いキューブでは鋭いエッジのような特徴を保持できないということである。この問題を解決するために、<strong>Extended Marching Cubes</strong>という方法が以下の論文で提案されている。</p>

<p>Kobbelt et al. 2001, “Feature Sensitive Surface Extraction from Volume Data” <br />
<a href="https://www.graphics.rwth-aachen.de/media/papers/feature1.pdf" target="_blank">https://www.graphics.rwth-aachen.de/media/papers/feature1.pdf</a></p>

<p>この方法ではマーチング・キューブ法同様に、同じサイズのキューブを使う。まずマーチング・キューブ法でメッシュを生成し、各頂点の法線を計算する。もし各キューブ内で発生させた頂点の法線の向きが一定以上開いていたら、feature sampleと呼ばれる余剰の点を発生させて、その点とキューブ内の頂点を結んで錐形状を作る。最後に、feature sampleを含む三角形のエッジを順に見ていき、もしエッジをフリップさせたときにfeature sampleをエッジが結ぶようになるなら、フリップ結果を保存する(論文の図9を参照)。こうすることで、キューブの数を小さく保ちながらも、鋭いエッジの情報を復元することが可能となる。</p>

<p>上記の問題を解決する別の方法に、以下の論文で提案された<strong>Dual Contouring</strong>もある。</p>

<p>Loasso et al. 2002, “Dual Contouring of Hermite Data” <br />
<a href="https://www.cse.wustl.edu/~taoju/research/dualContour.pdf" target="_blank">https://www.cse.wustl.edu/~taoju/research/dualContour.pdf</a></p>

<p>この方法はExtended Marching Cubesのようにキューブの内部に点を発生させるのだが、通常のマーチング・キューブ法とは異なり、キューブのエッジ上には点を発生させない。その代わりに、両端点の符号が異なるエッジがある場合には、そのエッジを含む4つのキューブに発生させた点を結んだ四角形を生成する。この部分が”dual”という言葉が入っている所以である。</p>

<p>Dual Contouringは通常のマーチング・キューブでキューブの中に埋もれてしまう特徴を、キューブ内に1つずつ発生させる頂点の位置を調整することで保持することを試みる。Dual Contouringにおいては、各キューブのエッジ上のどの位置を面が通るかという情報があり、そのエッジ上の点における法線が求まっていると考える (このようなデータをHermiteデータという)。</p>

<p>キューブの内部で符号が切れ変わっているときに発生させる点の位置は、このエッジ上の頂点位置と法線の情報を使いQEM (quadric error metric)を減少させるように選ばれる。論文中の定義(式(1))から分かる通り、QEMが小さくなれば、各エッジ上の頂点における法線が、復元されるメッシュにおいても保たれるようになる。</p>

<p>Dual ContouringはHermiteデータに対してしか用いることができないが、マーチング・キューブのように三角形が発生するパターンを定義しておく必要がなく、実装の苦労が少なくて済む。</p>

<p>最後に紹介する方法は<strong>Dual Marching Cubes</strong>と呼ばれる方法で、以下の論文で提案されている。</p>

<p>Nielsen et al. 2004, “Dual Marching Cubes: Primal Contouring of Dual Grids” <br />
<a href="https://people.eecs.berkeley.edu/~jrs/meshpapers/SchaeferWarren.pdf" target="_blank">https://people.eecs.berkeley.edu/~jrs/meshpapers/SchaeferWarren.pdf</a></p>

<p>この方法は、これまでの方法のように同じサイズのキューブを使うのではなく、八分木上に定義される”dual grid”上でマーチング・キューブ法を実行する。八分木は上記のdual contouringでも用いられていたQEMが十分に小さくなるまで分割される。各八分木のノード内に発生させられた点をつないでいくと、dual gridが作られるので、各dual gridに対して通常のマーチング・キューブ法で三角形を発生させる。</p>

<p>こうすることで、より細かな特徴を持つ場所に、より細かな三角形が発生するようになり、データ量を大幅に削減することができる。ただし、dual gridを発生させる際に八分木上のノード同士の隣接関係を調べる必要があるため、実装は少し複雑になる。</p>

</div>



    </div>
  </div>

  <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  <footer class="site-footer h-card">
    <data class="u-url" href="//programming-for-beginners/"></data>

    <div class="wrapper">
      <div class="container content">
        <div class="footer-col-wrapper">
          <div class="footer-col footer-col-1">
            <ul class="contact-list">
              <li class="p-name">programming-for-beginners</li>
              <li><a class="u-email" href="mailto:tatsy.mail@gmail.com">tatsy.mail@gmail.com</a></li>
            </ul>
          </div>

          <div class="footer-col footer-col-2">
            <ul class="social-media-list">
              <li>
                <a href="https://github.com/tatsy">
                  <svg class="svg-icon">
                    <use xlink:href="/programming-for-beginners/public/minima-social-icons.svg#github"></use>
                  </svg>
                  <span class="username">tatsy</span>
                </a>
              </li>
            </ul>
          </div>

          <div class="footer-col footer-col-3">
            <p>初心者・中級者向けC++/Pythonプログラミング</p>
          </div>
        </div>
      </div>
    </div>
  </footer>


  <script src='/programming-for-beginners/public/js/script.js'></script>



</body>

</html>