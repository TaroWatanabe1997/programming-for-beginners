---
layout: post
title: 大津の二値化による境界値の決定
---

マーチング・キューブ法でボリュームデータをメッシュにする際には、ボリューム内のCT値が一定の場所を結んでできる曲面を抽出する。この曲面を**等値面**と呼ぶ。

一つの材質から構成される物体のCT値は空気の部分と物体の部分の2つに分割でき、それらの場所のCT値はかなり離れた値をとっていることが期待される。このような2つの分布を単一の閾値により分割する際に閾値の値を分布の情報から自動決定する方法として大津の二値化が広く知られている。

## 大津の二値化の概要

大津の二値化については、ウェブ上にも多くの解説記事があるので、その概要を述べるに留める。

大津の二値化では、とある閾値の候補を用いてデータを2つのグループに分けたときに、グループ内の平均分散 $\sigma_w^2$とグループ間の分散$\sigma_b^2$を以下のように定義する。

$$
\sigma_w^2 = \frac{n_1 \sigma_1^2 + n_2 \sigma_2^2}{n_1 + n_2}
$$

$$
\sigma_b^2 = \frac{n_1 (\mu_1 - \mu)^2 + n_2 (\mu_2 - \mu)^2}{n_1 + n_2}
$$

上記の式において、$\mu$はデータ全体の平均、$\mu_1, \mu_2$は各グループでの平均、$\sigma_1^2, \sigma_2^2$は各グループの分散、$n_1, n_2$は各グループに含まれるデータの総数を表す。

これらを用いると、2つのグループの分散度$S$が、グループ内分散とグループ間分散の比として以下のように表せる。

$$
S = \frac{\sigma_w^2}{\sigma_b^2}
$$

この分散度をすべての閾値の候補に対して計算し、最も分散度が大きい(=データが最もはっきり分割できる)閾値を求めるのが大津の二値化のアルゴリズムである。

## 大津の二値化の実装

上記の式に従い、平均と分散を求めようとすると、プログラムとしての効率はどうだろうか？

今、ボリュームデータに含まれているデータはそのCT値の大きさを元にヒストグラム化されているとしよう。データの範囲が$[0, n-1]$とすれば、ヒストグラムとは各 $i \in [0, n-1]$につき、データの頻度$h_i$が求まっていることに相当する。

このヒストグラムの値を用いると値の平均ならびに分散は以下のように計算できる。

$$
\mu = \frac{1}{n} \sum_{i=0}^{n-1} h_i i
$$

同様に、分散は以下のように計算できる。

$$
\sigma = \frac{1}{n} \sum_{i=0}^{n-1} h_i (i - \mu)^2
$$

これはグループ内の平均や分散についても、同様なので、各グループで平均や分散を求める操作の計算量は$O(n)$と見積もられる。

今、閾値の候補は$n$個あるから、このままだと計算量は$O(n^2)$になりそうだ。しかし、CT値が16bitの符号なし整数、すなわち0-65535の値で表されていることを考えると$n^2$は$10^9$程度のオーダーとなってしまい、計算量が大きすぎる。

余談になるが、現代のCPUは3GHz程度のクロック数なので、単純な計算が1秒間に$3 \times 10^9$できるが、実際の計算では目安として計算量が$10^7$のオーダーを超えると一瞬では計算が終わらなくなる。

### 効率的な実装

グループ内分散およびグループ間分散を求めるに当たり、データ全体の平均と分散は一度だけ計算しておけば良いので、計算量には大きな影響を及ぼさない。問題は閾値を変更するごとに変化してしまう各グループの平均と分散だ。

今、閾値$T$について分散を考えていると、各グループの平均は次のように表せる。

$$
\begin{aligned}
    \mu_1 &= \frac{1}{n_1} \sum_{i=0}^{n_1} h_i i, & n_1 &= T \\
    \mu_2 &= \frac{1}{n_2} \sum_{i=T}^{T + n_2 - 1} h_i i, & n_2 &= n - T \\
\end{aligned}
$$

この式をよく見ると、Tが1増えたときには、以下の操作を行うことで、平均の値が簡単に更新できることが分かる。

* $n_1$を1増やし、$n_2$を1減らす。
* $\Sigma$の中に含まれる $h_T T$を$\mu_2$の側から$\mu_1$の側に移項する。

この操作をすれば、いちいち、各閾値$T$に対してヒストグラムの値を足し上げる操作をする必要がないので、非常に効率的であることが分かる。上記の2つの操作はデータの値の範囲に寄らず、同様の操作は各グループの分散を求めるときにも使えるので、結果として大津の二値化の計算量が$O(n)$まで減少する。

ここまでの議論をまとめると、効率的な大津の二値化の実装では、はじめに$T=0$のときのグループ2に対する平均と分散を求めておき (これらはデータ全体の平均と分散に一致する)、閾値を増やすごとに、上記の移項の操作を行いながら、最大の分散度を与える閾値を探索すれば良い。

サンプルプログラムの`mcubes.cpp`内にある関数 `getThresholdOtsu` に大津の二値化を実装してみよう。